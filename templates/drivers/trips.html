{% extends 'base.html' %}
{% load math_extras %}

{% block title %}Мои поездки - RahiSafed{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col">
    <h1 class="text-white fw-bold">
      <i class="fas fa-route me-2"></i> Мои поездки
    </h1>
  </div>
  <div class="col-auto">
    <a href="{% url 'create_trip' %}" class="btn btn-light btn-lg">
      <i class="fas fa-plus-circle me-2"></i> Создать поездку
    </a>
  </div>
</div>

<div class="row g-4 mb-5">
  <div class="col-md-3">
    <div class="stat-card">
      <i class="fas fa-route fa-3x mb-3"></i>
      <h3>{{ active_trips_count }}</h3>
      <p class="mb-0">Активных поездок</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #34d399);">
      <i class="fas fa-users fa-3x mb-3"></i>
      <h3>{{ total_passengers }}</h3>
      <p class="mb-0">Всего пассажиров</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #f97316);">
      <i class="fas fa-clock fa-3x mb-3"></i>
      <h3>{{ upcoming_trips_count }}</h3>
      <p class="mb-0">Предстоящих</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
      <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
      <h3>{{ total_earnings }}</h3>
      <p class="mb-0">Сомони заработано</p>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" name="filter" id="all" checked>
      <label class="btn btn-outline-primary" for="all" onclick="filterTrips('all')">
        <i class="fas fa-list me-2"></i> Все
      </label>
            
      <input type="radio" class="btn-check" name="filter" id="active">
      <label class="btn btn-outline-primary" for="active" onclick="filterTrips('active')">
        <i class="fas fa-check-circle me-2"></i> Активные
      </label>
            
      <input type="radio" class="btn-check" name="filter" id="upcoming">
      <label class="btn btn-outline-primary" for="upcoming" onclick="filterTrips('upcoming')">
        <i class="fas fa-calendar-alt me-2"></i> Предстоящие
      </label>
            
      <input type="radio" class="btn-check" name="filter" id="completed">
      <label class="btn btn-outline-primary" for="completed" onclick="filterTrips('completed')">
        <i class="fas fa-history me-2"></i> Завершенные
      </label>
    </div>
  </div>
</div>

{% if trips %}
  <div class="row g-4" id="tripsList">
    {% for trip in trips %}
    <div class="col-lg-6 trip-item" 
       data-status="{% if trip.is_active %}active{% else %}inactive{% endif %}"
       data-time="{% if trip.departure_date >= today %}upcoming{% else %}completed{% endif %}">
      <div class="card h-100">
        <div class="card-body p-4">
          <!-- Статус -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            {% if trip.is_active %}
              <span class="badge bg-success">
                <i class="fas fa-check-circle me-1"></i> Активна
              </span>
            {% else %}
              <span class="badge bg-secondary">
                <i class="fas fa-times-circle me-1"></i> Неактивна
              </span>
            {% endif %}
                        
            <div class="dropdown">
              <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="{% url 'trip_detail' trip.id %}">
                    <i class="fas fa-eye me-2"></i> Посмотреть
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'edit_trip' trip.id %}">
                    <i class="fas fa-edit me-2"></i> Редактировать
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{% url 'trip_passengers' trip.id %}">
                    <i class="fas fa-users me-2"></i> Пассажиры
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item text-danger" href="#" 
                     onclick="cancelTrip({{ trip.id }})">
                    <i class="fas fa-ban me-2"></i> Отменить
                  </a>
                </li>
              </ul>
            </div>
          </div>
                    
          <div class="trip-route mb-3">
            <div class="city" style="font-size: 1.1rem;">
              {{ trip.origin.name_ru }}
            </div>
            <div class="arrow" style="font-size: 1.2rem;">
              <i class="fas fa-arrow-right"></i>
            </div>
            <div class="city" style="font-size: 1.1rem;">
              {{ trip.destination.name_ru }}
            </div>
          </div>
                    
          <div class="d-flex flex-wrap flex-md-nowrap gap-3 mb-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-calendar text-primary me-2"></i>
              <span>{{ trip.departure_date|date:"d.m.Y" }}</span>
            </div>
            <div class="d-flex align-items-center">
              <i class="fas fa-clock text-primary me-2"></i>
              <span>{{ trip.departure_time|time:"H:i" }}</span>
            </div>
          </div>
                    
          <div class="row g-3 mb-3">
            <div class="col-12 col-sm-6">
              <div class="p-3 bg-light rounded">
                <div class="small text-muted mb-1">
                  <i class="fas fa-ticket-alt me-1"></i> Бронирований
                </div>
                <div class="fw-bold fs-5">
                  {{ trip.computed_confirmed_count }}
                </div>
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="p-3 bg-light rounded">
                <div class="small text-muted mb-1">
                  <i class="fas fa-users me-1"></i> Пассажиров
                </div>
                <div class="fw-bold fs-5">
                  {{ trip.computed_booked_seats }} / {{ trip.available_seats }}
                </div>
              </div>
            </div>
          </div>
                    
          <div class="mb-3">
            <div class="d-flex justify-content-between small text-muted mb-1">
              <span>Заполнено мест</span>
              <span>{{ trip.computed_booked_seats|floatformat:0 }}/{{ trip.available_seats }}</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar" 
                 style="width: {% if trip.available_seats %}{{ trip.computed_booked_seats|divide:trip.available_seats|multiply:100 }}%{% else %}0%{% endif %}">
              </div>
            </div>
          </div>
                    
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <div class="w-100 w-md-auto">
              <div class="small text-muted">Цена за место</div>
              <div class="fw-bold fs-5 text-primary">{{ trip.price_per_seat }} с.</div>
            </div>
            <div class="text-start text-md-end w-100 w-md-auto">
              <div class="small text-muted">Потенциальный доход</div>
              <div class="fw-bold fs-5 text-success">
                {{ trip.price_per_seat|multiply:trip.computed_booked_seats }} с.
              </div>
            </div>
          </div>
                    
          <div class="d-grid gap-2 mt-3">
            <a href="{% url 'trip_passengers' trip.id %}" class="btn btn-primary">
              <i class="fas fa-users me-2"></i> 
              Посмотреть пассажиров ({{ trip.computed_confirmed_count }})
            </a>
            {% if trip.computed_confirmed_count > 0 %}
              <button class="btn btn-outline-primary" onclick="notifyPassengers({{ trip.id }})">
                <i class="fas fa-bell me-2"></i> Уведомить всех
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
{% else %}
  <div class="card text-center py-5">
    <div class="card-body">
      <i class="fas fa-route fa-5x text-muted mb-4"></i>
      <h3 class="fw-bold mb-3">У вас пока нет поездок</h3>
      <p class="text-muted mb-4">Создайте свою первую поездку и начните зарабатывать</p>
      <a href="{% url 'create_trip' %}" class="btn btn-primary btn-lg">
        <i class="fas fa-plus-circle me-2"></i> Создать первую поездку
      </a>
    </div>
  </div>
{% endif %}

<div class="card mt-5" style="background: linear-gradient(135deg, #667eea, #764ba2);">
  <div class="card-body text-white p-4">
    <h5 class="fw-bold mb-3">
      <i class="fas fa-lightbulb me-2"></i> Советы для успешных поездок
    </h5>
    <div class="row g-3">
      <div class="col-md-4">
        <div class="d-flex">
          <i class="fas fa-check-circle fa-2x me-3"></i>
          <div>
            <h6 class="fw-bold">Будьте пунктуальны</h6>
            <p class="small mb-0">Приезжайте за 5-10 минут до времени отправления</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-flex">
          <i class="fas fa-comments fa-2x me-3"></i>
          <div>
            <h6 class="fw-bold">Общайтесь</h6>
            <p class="small mb-0">Отвечайте на сообщения пассажиров быстро</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-flex">
          <i class="fas fa-car fa-2x me-3"></i>
          <div>
            <h6 class="fw-bold">Чистота машины</h6>
            <p class="small mb-0">Поддерживайте автомобиль в чистоте</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function filterTrips(type) {
    const items = document.querySelectorAll('.trip-item');
        
    items.forEach(item => {
      if (type === 'all') {
        item.style.display = 'block';
      } else if (type === 'active') {
        item.style.display = item.dataset.status === 'active' ? 'block' : 'none';
      } else if (type === 'upcoming') {
        item.style.display = item.dataset.time === 'upcoming' ? 'block' : 'none';
      } else if (type === 'completed') {
        item.style.display = item.dataset.time === 'completed' ? 'block' : 'none';
      }
    });
  }
    
  function cancelTrip(tripId) {
    if (confirm('Вы уверены что хотите отменить эту поездку? Все пассажиры получат уведомление.')) {
      window.location.href = `{% url 'cancel_trip' 0 %}`.replace('0', tripId);
    }
  }
    
  function notifyPassengers(tripId) {
    if (confirm('Отправить уведомление всем пассажирам этой поездки?')) {
      alert('Уведомления отправлены!');
    }
  }
</script>

<style>
  .trip-item {
    transition: all 0.3s ease;
  }
  
  .trip-item:hover {
    transform: translateY(-5px);
  }
  
  .stat-card {
    animation: scaleIn 0.5s ease-out;
  }
  
  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @media (max-width: 768px) {
    .row.mb-4 > .col-auto {
      width: 100%;
      margin-top: 1rem;
    }

    .row.mb-4 > .col-auto .btn {
      width: 100%;
    }

    .row.g-4.mb-5 > [class*="col-"] {
      margin-bottom: 1rem;
    }

    .stat-card {
      padding: 1.5rem !important;
    }

    .stat-card h3 {
      font-size: 2rem !important;
    }

    .stat-card i {
      font-size: 2rem !important;
    }

    .btn-group {
      flex-direction: column;
      width: 100%;
    }

    .btn-group .btn {
      border-radius: var(--radius-md) !important;
      margin-bottom: 0.5rem;
    }

    .card-body.p-4 {
      padding: 1.25rem !important;
    }

    .d-flex.flex-wrap.justify-content-between {
      flex-direction: column;
      gap: 1rem !important;
    }

    .d-flex.flex-wrap.justify-content-between > div {
      width: 100%;
    }

    .text-end {
      text-align: left !important;
    }
  }

  @media (max-width: 576px) {
    .stat-card {
      padding: 1.25rem !important;
    }

    .stat-card h3 {
      font-size: 1.75rem !important;
    }

    .trip-route {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .trip-route .arrow {
      transform: rotate(90deg);
      margin: 0.5rem 0;
    }
  }
</style>
{% endblock %}
