{% extends 'base.html' %}

{% block title %}Стать водителем - RahiSafed{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="text-center text-white mb-5">
            <h1 class="display-4 fw-bold mb-3">
                <i class="fas fa-steering-wheel me-3"></i> Станьте водителем
            </h1>
            <p class="lead">Зарабатывайте на своих поездках и помогайте другим</p>
        </div>
        
        <div class="card mb-4">
            <div class="card-body p-4">
                <h4 class="fw-bold mb-4">Преимущества для водителей:</h4>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <i class="fas fa-money-bill-wave fa-3x text-success mb-3"></i>
                            <h6 class="fw-bold">Экономия</h6>
                            <p class="small text-muted">Окупайте расходы на бензин</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <i class="fas fa-calendar-check fa-3x text-primary mb-3"></i>
                            <h6 class="fw-bold">Гибкий график</h6>
                            <p class="small text-muted">Публикуйте поездки когда удобно</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3">
                            <i class="fas fa-users fa-3x text-info mb-3"></i>
                            <h6 class="fw-bold">Общение</h6>
                            <p class="small text-muted">Интересные попутчики</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" id="driverForm">
                    {% csrf_token %}
                    
                    <div class="form-step active" id="step1">
                        <h5 class="fw-bold mb-4">
                            <span class="badge bg-primary me-2">Шаг 1</span>
                            Опыт вождения
                        </h5>
                        
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                Сколько лет вы за рулём?
                            </label>
                            <input type="number" name="experience" class="form-control form-control-lg" 
                                   min="0" max="60" required placeholder="Например: 5"
                                   value="{{ form_data.experience|default_if_none:'' }}">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Укажите ваш общий водительский стаж
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary btn-lg" onclick="nextStep(2)">
                                Далее <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-step" id="step2">
                        <h5 class="fw-bold mb-4">
                            <span class="badge bg-primary me-2">Шаг 2</span>
                            Данные автомобиля
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Номерной знак</label>
                                <input type="text" name="license_plate" class="form-control" 
                                       required placeholder="1234abAB" pattern="[0-9]{4}[a-z]{2}[A-Z]{2}"
                                       maxlength="8" autocomplete="off"
                                       value="{{ form_data.license_plate|default_if_none:'' }}">
                                <div class="form-text">Формат: 1234abAB — 4 цифры, 2 строчные латинские буквы, 2 заглавные буквы региона</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Год выпуска</label>
                                <input type="number" name="car_year" class="form-control" 
                                       min="1980" max="2025" required placeholder="2020"
                                       value="{{ form_data.car_year|default_if_none:'' }}">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Марка автомобиля</label>
                                <input type="text" name="car_brand" class="form-control" 
                                       required placeholder="Toyota"
                                       value="{{ form_data.car_brand|default_if_none:'' }}">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Модель</label>
                                <input type="text" name="car_model" class="form-control" 
                                       required placeholder="Camry"
                                       value="{{ form_data.car_model|default_if_none:'' }}">
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-semibold">VIN-номер</label>
                                <input type="text" name="vin_number" class="form-control" 
                                       required placeholder="1HGBH41JXMN109186" 
                                       pattern="[A-HJ-NPR-Z0-9]{17}" maxlength="17"
                                       value="{{ form_data.vin_number|default_if_none:'' }}">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    17 символов, без букв I, O, Q
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep(1)">
                                <i class="fas fa-arrow-left me-2"></i> Назад
                            </button>
                            <button type="button" class="btn btn-primary btn-lg" onclick="nextStep(3)">
                                Далее <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-step" id="step3">
                        <h5 class="fw-bold mb-4">
                            <span class="badge bg-primary me-2">Шаг 3</span>
                            Фотография автомобиля
                        </h5>
                        
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Загрузите фото вашего автомобиля</label>
                            <div class="card bg-light border-2 border-dashed text-center p-5" 
                                 id="dropZone" style="cursor: pointer;">
                                <input type="file" name="car_photo" id="carPhoto" 
                                       accept="image/*" class="d-none" required>
                                <div id="uploadPrompt">
                                    <i class="fas fa-cloud-upload-alt fa-5x text-muted mb-3"></i>
                                    <p class="fw-bold mb-2">Нажмите или перетащите фото сюда</p>
                                    <p class="text-muted small">Поддерживаются JPG, PNG (макс. 5 МБ)</p>
                                </div>
                                <div id="imagePreview" class="d-none">
                                    <img id="previewImg" class="img-fluid rounded" style="max-height: 300px;">
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="removePhoto()">
                                            <i class="fas fa-trash me-1"></i> Удалить
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text mt-2">
                                <i class="fas fa-lightbulb me-1"></i>
                                <strong>Советы:</strong> Сфотографируйте машину в хорошем освещении, 
                                убедитесь что номерной знак виден
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep(2)">
                                <i class="fas fa-arrow-left me-2"></i> Назад
                            </button>
                            <button type="button" class="btn btn-primary btn-lg" onclick="nextStep(4)">
                                Далее <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-step" id="step4">
                        <h5 class="fw-bold mb-4">
                            <span class="badge bg-success me-2">Шаг 4</span>
                            Подтверждение
                        </h5>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Проверьте введенные данные перед отправкой
                        </div>
                        
                        <div id="summaryContent" class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">Ваши данные:</h6>
                                <div id="summary"></div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="terms" required>
                            <label class="form-check-label" for="terms">
                                Я соглашаюсь с <a href="#">Правилами сервиса</a> и 
                                <a href="#">Политикой конфиденциальности</a>
                            </label>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevStep(3)">
                                <i class="fas fa-arrow-left me-2"></i> Назад
                            </button>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check-circle me-2"></i> Завершить регистрацию
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <small class="text-muted">Прогресс регистрации</small>
                    <small class="text-muted"><span id="currentStep">1</span> из 4</small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" id="progressBar" role="progressbar" 
                         style="width: 25%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const LICENSE_PLATE_PATTERN = /^\d{4}[a-z]{2}[A-Z]{2}$/;

    const sanitizeLicensePlate = (value = '') => {
        const cleaned = value.replace(/[^0-9a-zA-Z]/gi, '').slice(0, 8);
        if (cleaned.length <= 6) {
            return cleaned.toLowerCase();
        }
        // Первые 6 символов в нижний регистр, последние 2 в верхний
        return cleaned.slice(0, 6).toLowerCase() + cleaned.slice(6).toUpperCase();
    };

    const formatLicensePlateDisplay = (value = '') => {
        const plate = sanitizeLicensePlate(value);
        if (LICENSE_PLATE_PATTERN.test(plate)) {
            return `${plate.slice(0, 4)} ${plate.slice(4, 6)} ${plate.slice(6)}`;
        }
        return plate;
    };

    const licensePlateInput = document.querySelector('[name="license_plate"]');
    if (licensePlateInput) {
        const normalized = sanitizeLicensePlate(licensePlateInput.value);
        if (normalized !== licensePlateInput.value) {
            licensePlateInput.value = normalized;
        }

        licensePlateInput.addEventListener('input', (event) => {
            const current = event.target.value;
            const sanitized = sanitizeLicensePlate(current);
            if (current !== sanitized) {
                const cursorPos = event.target.selectionStart;
                event.target.value = sanitized;
                // Сохраняем позицию курсора
                const newPos = Math.min(cursorPos, sanitized.length);
                event.target.setSelectionRange(newPos, newPos);
            }
        });

        licensePlateInput.addEventListener('blur', (event) => {
            event.target.value = sanitizeLicensePlate(event.target.value);
        });
    }

    let currentStep = 1;
    
    function nextStep(step) {
        const currentStepElement = document.getElementById('step' + currentStep);
        const inputs = currentStepElement.querySelectorAll('input[required]');
        let valid = true;
        
        inputs.forEach(input => {
            if (!input.checkValidity()) {
                input.reportValidity();
                valid = false;
            }
        });
        
        if (!valid) return;
        
        document.getElementById('step' + currentStep).classList.remove('active');
        document.getElementById('step' + step).classList.add('active');
        currentStep = step;
        
        document.getElementById('currentStep').textContent = step;
        document.getElementById('progressBar').style.width = (step * 25) + '%';
        
        if (step === 4) {
            updateSummary();
        }
        
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
    
    function prevStep(step) {
        document.getElementById('step' + currentStep).classList.remove('active');
        document.getElementById('step' + step).classList.add('active');
        currentStep = step;
        
        document.getElementById('currentStep').textContent = step;
        document.getElementById('progressBar').style.width = (step * 25) + '%';
        
        window.scrollTo({top: 0, behavior: 'smooth'});
    }
    
    function updateSummary() {
        const experience = document.querySelector('[name="experience"]').value;
        const licensePlateValue = document.querySelector('[name="license_plate"]').value;
        const carBrand = document.querySelector('[name="car_brand"]').value;
        const carModel = document.querySelector('[name="car_model"]').value;
        const carYear = document.querySelector('[name="car_year"]').value;
        const vinNumber = document.querySelector('[name="vin_number"]').value;

        const formattedPlate = formatLicensePlateDisplay(licensePlateValue);
        
        const summary = `
            <div class="row g-3">
                <div class="col-md-6">
                    <strong><i class="fas fa-steering-wheel me-2 text-primary"></i> Опыт вождения:</strong><br>
                    <span class="ms-4">${experience} лет</span>
                </div>
                <div class="col-md-6">
                    <strong><i class="fas fa-id-card me-2 text-primary"></i> Номер:</strong><br>
                    <span class="ms-4">${formattedPlate || '—'}</span>
                </div>
                <div class="col-md-6">
                    <strong><i class="fas fa-car me-2 text-primary"></i> Автомобиль:</strong><br>
                    <span class="ms-4">${carBrand} ${carModel}</span>
                </div>
                <div class="col-md-6">
                    <strong><i class="fas fa-calendar me-2 text-primary"></i> Год выпуска:</strong><br>
                    <span class="ms-4">${carYear}</span>
                </div>
                <div class="col-12">
                    <strong><i class="fas fa-barcode me-2 text-primary"></i> VIN:</strong><br>
                    <span class="ms-4">${vinNumber}</span>
                </div>
            </div>
        `;
        
        document.getElementById('summary').innerHTML = summary;
    }
    
    const dropZone = document.getElementById('dropZone');
    const carPhoto = document.getElementById('carPhoto');
    
    dropZone.addEventListener('click', () => carPhoto.click());
    
    carPhoto.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('uploadPrompt').classList.add('d-none');
                document.getElementById('imagePreview').classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    });
    
    function removePhoto() {
        document.getElementById('carPhoto').value = '';
        document.getElementById('uploadPrompt').classList.remove('d-none');
        document.getElementById('imagePreview').classList.add('d-none');
    }
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--primary)';
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '';
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            carPhoto.files = files;
            carPhoto.dispatchEvent(new Event('change'));
        }
    });
</script>

<style>
    .form-step {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }
    
    .form-step.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .border-dashed {
        border-style: dashed !important;
    }
    
    #dropZone:hover {
        background-color: #f0f0f0;
    }
</style>
{% endblock %}